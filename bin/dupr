#!/bin/sh
set -e
SH=/bin/sh
GIT=/usr/bin/git
DUNFOLD=/usr/bin/dunfold
DUPR_DEFCOLL=~/.defcoll

_c36 () {
	echo -n "\033[1;36m" $@
}

_c162 () {
	echo -n "\033[1;38;5;162m" $@
}

_c () {
	echo -n "\033[0m" $@
}

dupr_fetch () {
	_c162 "→ Fetching"; _c36 "DefaultCollection"; _c162 "..."; _c "\n"
	if ! test -r $DUPR_DEFCOLL; then
		$GIT clone https://github.com/dupr/DefaultCollection $DUPR_DEFCOLL
	else
		cd $DUPR_DEFCOLL; $GIT pull
	fi
}

dupr_unfold () {
	test -z "$1" && (echo "Unfolding nothing"; false)
	_c162 "→ Unfolding"; _c36 "$1"; _c162 "into"; _c36 ".sh"; _c162 "and";
	_c36 ".hft"; _c162 "..."; _c "\n"
	# Splits the .durpkg into .sh script and .hft file
	$DUNFOLD $1
	_c162 "→ Executing"; _c36 "${1%.rcp}.sh"; _c162 "..."; _c "\n"
	# Execute the resulting .sh script
	$SH ${1%.rcp}.sh
}

dupr_deb () {
	local dir=${1%.rcp}
	start_time="$(date -u +%s)"
	dupr_unfold $1
	cd $dir; dpkg-buildpackage -us -uc
	end_time="$(date -u +%s)"
	_c162 "→ Completed"; _c36 "$1"; _c162 "in";
	_c36 "$(($end_time-$start_time))"; _c162 "seconds."; _c "\n"
}

dupr_dsc () {
	local dir=${1%.rcp}
	start_time="$(date -u +%s)"
	dupr_unfold $1
	cd $dir; dpkg-buildpackage -us -uc -nc -S
	end_time="$(date -u +%s)"
	_c162 "→ Completed"; _c36 "$1"; _c162 "in";
	_c36 "$(($end_time-$start_time))"; _c162 "seconds."; _c "\n"
}

dupr_create () {
	if test -n "$1"; then
		cp -v /usr/share/doc/duprkit/examples/template-default.rcp $1.rcp
	else
		echo "Please specify recipe name"
	fi
}

dupr_minimal () {
	if test -n "$1"; then
		cat /usr/share/doc/duprkit/examples/template-default.rcp \
			| awk '(!/^[[:blank:]]*#/)&&(!/^\^#/)||(/^#!/){print}' > $1.rcp
	else
		echo "Please specify recipe name"
	fi
}

usage () {
	echo "\033[1;38;5;162m-- Dasteriskian User Package Repo Kit --\033[0m"
	echo "Usage: $0 action [args]"
	echo ""
	echo "Actions"
	echo "   f|fetch              Fetch the default DUPR collection."
	echo "   s|search [keyword] [dir]"
	echo "                        Search in the [dir, default=.] collection."
	echo "   u|unfold <.rcp>      Unfold .rcp file into debianized source tree."
	echo "   c|create <name>      Create talky template file: <name>.rcp"
	echo "   m|minimal <name>     Create minimal template: <name>.rcp"
	echo "   l|ls [dir]           List packages in collection: [dir]"
	echo "   deb <.rcp>           Build .deb files from .rcp"
	echo "   dsc <.rcp>           Build .dsc files from .rcp"
	echo "   help                 Print this usage information."
}

case "$1" in
	f|fetch)
		shift
		dupr_fetch $@
		;;
	s|search)
		shift
		duprCollector -s $@
		;;
	deb)
		shift
		dupr_deb $@
		;;
	dsc)
		shift
		dupr_dsc $@
		;;
	u|unfold)
		shift
		dupr_unfold $@
		;;
	c|create)
		shift
		dupr_create $@
		;;
	m|minimal)
		shift
		dupr_minimal $@
		;;
	ls|list)
		shift
		duprCollector $DUPR_DEFCOLL $@
		;;
	*)
		usage;;
esac

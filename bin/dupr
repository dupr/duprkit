#!/bin/sh
set -e

DUPR_DEFCOLL=~/.defcoll

dupr_fetch () {
	echo "\033[1;38;5;162m→ Fetching \033[1;36mDefaultCollection\033[1;38;5;162m ...\033[0m"
	if ! test -r $DUPR_DEFCOLL; then
		git clone https://github.com/dupr/DefaultCollection $DUPR_DEFCOLL
	else
		cd $DUPR_DEFCOLL; git pull
	fi
}

dupr_build () {
	test -z "$1" && (echo "Building nothing"; false)
	echo "\033[1;38;5;162m→ Unfolding \033[1;36m$1\033[1;38;5;162m into \033[1;36m.sh\033[1;38;5;162m and \033[1;36mdebian/\033[1;38;5;162m dir ...\033[0m"
	# Splits the .durpkg into .sh script and .hft file
	dunfold $1
	echo "\033[1;38;5;162m→ Triggering build for \033[1;36m$1\033[1;38;5;162m ...\033[0m"
	start_time="$(date -u +%s)"
	# Execute the resulting .sh script
	bash $1.sh
	sleep 1
	end_time="$(date -u +%s)"
	echo "\033[1;38;5;162m→ Completed \033[1;36m$1\033[1;38;5;162m in \033[1;36m$(($end_time-$start_time))\033[1;38;5;162m seconds.\033[0m"
}

dupr_create () {
	if test -z "$1"; then
		echo -n "Creating template ... "
		cp -v /usr/share/doc/duprkit/examples/template-default.durpkg .
	else
		echo -n "Creating comment-less template ... $1.durpkg"
		cat /usr/share/doc/duprkit/examples/template-default.durpkg \
			| awk '!/^#/&&!/^\^#/{print}' > $1.durpkg
	fi
}

usage () {
	echo "\033[1;38;5;162m-- Dasteriskian User Package Repo Kit --\033[0m"
	echo "Usage: $0 action [args]"
	echo ""
	echo "Actions"
	echo "   f|fetch              Fetch the default DUPR collection."
	echo "   s|search [keyword] [dir]"
	echo "                        Search in the [dir, default=.] collection."
	echo "   b|build <.durpkg>    Build .deb packages from .durpkg file."
	echo "   c|create [name]      Create a template file: <name>.durpkg"
	echo "   l|ls [dir]           List packages in collection: [dir]"
	echo "   help                 Print this usage information."
}

case "$1" in
	f|fetch)
		shift
		dupr_fetch $@
		;;
	s|search)
		shift
		duprCollector -s $@
		;;
	b|build)
		shift
		#FIXME: impl: x, then build .deb
		dupr_build $@
		;;
	d|dsc)
		shift
		#FIXME: impl: x, then build .dsc
		dupr_dsc $@
		;;
	x|extract)
		shift
		#FIXME: impl: only extract files and prepare the debian dir
		dupr_extract $@
		;;
	c|create)
		shift
		dupr_create $@
		;;
	ls|list)
		shift
		duprCollector $DUPR_DEFCOLL $@
		;;
	*)
		usage;;
esac

#!/bin/sh
set -e
SH=/bin/sh
GIT=/usr/bin/git
DUNFOLD=/usr/bin/dunfold
DUPR_DEFCOLL=~/.defcoll

_c36 () {
	echo -n "\033[1;36m" $@
}

_c162 () {
	echo -n "\033[1;38;5;162m" $@
}

_c () {
	echo -n "\033[0m" $@
}

dupr_fetch () {
	_c162 "→ Fetching"; _c36 "DefaultCollection"; _c162 "..."; _c "\n"
	if ! test -r $DUPR_DEFCOLL; then
		$GIT clone https://github.com/dupr/DefaultCollection $DUPR_DEFCOLL
	else
		cd $DUPR_DEFCOLL; $GIT pull
	fi
}

dupr_build () {
	test -z "$1" && (echo "Building nothing"; false)
	_c162 "→ Unfolding"; _c36 "$1"; _c162 "into"; _c36 ".sh"; _c162 "and";
	_c36 "debian/"; _c162 "dir ..."; _c "\n"
	# Splits the .durpkg into .sh script and .hft file
	$DUNFOLD $1
	_c162 "→ Triggering build for"; _c36 "$1"; _c162 "..."; _c "\n"
	start_time="$(date -u +%s)"
	# Execute the resulting .sh script
	$SH $1.sh
	sleep 1
	end_time="$(date -u +%s)"
	_c162 "→ Completed"; _c36 "$1"; _c162 "in";
	_c36 "$(($end_time-$start_time))"; _c162 "seconds."; _c "\n"
}

dupr_create () {
	if test -z "$1"; then
		echo -n "Creating template ... "
		cp -v /usr/share/doc/duprkit/examples/template-default.durpkg .
	else
		echo -n "Creating comment-less template ... $1.durpkg"
		cat /usr/share/doc/duprkit/examples/template-default.durpkg \
			| awk '!/^#/&&!/^\^#/{print}' > $1.durpkg
	fi
}

usage () {
	echo "\033[1;38;5;162m-- Dasteriskian User Package Repo Kit --\033[0m"
	echo "Usage: $0 action [args]"
	echo ""
	echo "Actions"
	echo "   f|fetch              Fetch the default DUPR collection."
	echo "   s|search [keyword] [dir]"
	echo "                        Search in the [dir, default=.] collection."
	echo "   b|build <.durpkg>    Build .deb packages from .durpkg file."
	echo "   c|create [name]      Create a template file: <name>.durpkg"
	echo "   l|ls [dir]           List packages in collection: [dir]"
	echo "   help                 Print this usage information."
}

case "$1" in
	f|fetch)
		shift
		dupr_fetch $@
		;;
	s|search)
		shift
		duprCollector -s $@
		;;
	b|build)
		shift
		#FIXME: impl: x, then build .deb
		dupr_build $@
		;;
	d|dsc)
		shift
		#FIXME: impl: x, then build .dsc
		dupr_dsc $@
		;;
	x|extract)
		shift
		#FIXME: impl: only extract files and prepare the debian dir
		dupr_extract $@
		;;
	c|create)
		shift
		dupr_create $@
		;;
	ls|list)
		shift
		duprCollector $DUPR_DEFCOLL $@
		;;
	*)
		usage;;
esac

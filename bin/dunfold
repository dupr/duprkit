#!/usr/bin/python3
'''
Debian User Package Repository Toolkit: Recipe Unfolder
Copyright (C) 2019 M. Zhou <lumin@debian.org>
'''
import argparse
import sys, os, re, stat
from typing import *

__VERSION__ = '0.0g'

__RECIPE_SPEC__ = '''
Recipe Specification
--------------------

A .rcp file is a concatenation of a shell script and an HFT file.
It defines how to get and prepare the source tree, as well as how to
debianize the source tree.

Recipe Example
--------------

::
    src="foobar"
    ^ debian/compat
    11
    ^ debian/source/format
    3.0 (native)
'''


def recipe_unfold(path: str):
    '''
    Unfold a .rcp into a shell script and a HFT file
    '''
    recipe = open(path).readlines()
    if len(recipe) == 0:
        return
    if not recipe[0].startswith('#!'):
        SyntaxError("It must have a shebang!")
    fp_shell = open(re.sub('.rcp$', '', path) + '.sh', 'w')
    fp_hft = open(re.sub('.rcp$', '', path) + '.hft', 'w')
    lns_shell, lns_hft = [], []

    lns = lns_shell
    for line in recipe:
        if line.startswith('^'):
            lns = lns_hft
        lns.append(line)

    # nothing else to do with hft
    fp_hft.writelines(lns_hft)
    fp_hft.close()

    # add header and tail to the shell script
    lns_shell = [
            '#!/bin/sh\n',
            'set -e\n',
            '. /usr/share/duprkit/duprkit\n',
            'export DK_VERBOSE=1\n',
            '\n'
            ] + lns_shell + [
            '#--- BEGIN Prepare source and debian/ directory\n',
            'dk_get_source\n',
            'dk_prep_source\n',
            'dk_debianize\n',
            '#--- END Prepare source and debian/ directory\n',
            ]
    fp_shell.writelines(lns_shell)
    fp_shell.close()


if __name__ == '__main__':
    ag = argparse.ArgumentParser()
    ag.add_argument('recipe', type=str)
    ag = ag.parse_args()

    if ag.recipe:
        if ag.recipe.endswith('.rcp'):
            recipe_unfold(ag.recipe)
        else:
            raise Exception(f"Unsupported {ag.recipe}")

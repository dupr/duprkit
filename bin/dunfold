#!/usr/bin/python3
'''
Debian User Package Repository Toolkit: Recipe Unfolder
Copyright (C) 2019 M. Zhou <lumin@debian.org>
'''
import argparse
import sys, os, re, stat
from typing import *

__VERSION__ = '0.0f'

__RECIPE_SPEC__ = '''
Recipe Specification
--------------------

A .rcp file is a concatenation of a shell script and an HFT file.

Recipe Example
--------------

::
    src="foobar"
    ^ debian/compat
    11
    ^ debian/source/format
    3.0 (native)
'''


def recipe_unfold(path: str):
    '''
    Unfold a .rcp into a shell script and a HFT file
    '''
    recipe = open(path).readlines()
    if len(recipe) == 0:
        return
    if not recipe[0].startswith('#!'):
        SyntaxError("It must have a shebang!")
    fp_shell = open(re.sub('.recipe$', '', path) + '.sh', 'w')
    fp_hft = open(re.sub('.recipe$', '', path) + '.hft', 'w')

    fp = fp_shell
    for line in recipe:
        if line.startswith('^'):
            fp = fp_hft
        fp.write(line)


if __name__ == '__main__':
    ag = argparse.ArgumentParser()
    ag.add_argument('recipe', type=str)
    ag = ag.parse_args()

    if ag.recipe:
        if ag.recipe.endswith('.recipe') or ag.recipe.endswith('.rcp'):
            recipe_unfold(ag.recipe)
        else:
            raise Exception(f"Unsupported {ag.folded}")

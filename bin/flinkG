#!/usr/bin/perl6
=begin DESCRIPTION
  flinkG: Debian User Recipe (HFT) Guesser
  -- Guesses a recipe for the source tree under the current working directory.
  Copyright (C) 2019 M. Zhou <lumin@debian.org>
  License: MIT/Expat

  TODO: https://wiki.debian.org/AutomaticPackagingTools
=end DESCRIPTION
constant $__version__ = '0.1a';

sub guess_source () {
	my $source = '.'.IO.absolute.IO.basename;
	if $source ~~ /(.*)[\-||_]v?([\d||\.]+)$/ {
		$source = $0.Str;
	}
	return $source;
}

sub guess_version () {
	my $version = '0'; # the fallback when no clue is found
    my $source = '.'.IO.absolute.IO.basename;
	# Is the current working directory in <package>-<version> pattern?
	if $source ~~ /(.*)[\-||_]v?([\d||\.]+)$/ {
		$version= $1.Str;
	} elsif '.git/config'.IO.f { # is CWD a git workspace?
		$version = '0~git';
	}
	return $version;
}

sub guess_section () {
	return "utils";
}

sub guess_homepage () {
	my $homepage = '';
    if '.git/config'.IO.f {
        $homepage = qx/git remote get-url origin/.chomp
            .subst(':', '/').subst('git@', 'https://');
    }
	return $homepage;
}

sub guess_license () {
	my $license = '';
    if 'LICENSE'.IO.f || 'COPYING'.IO.f {
        if 'LICENSE'.IO.f {
			$license = qx/flinkV LICENSE/.chomp;
        } elsif 'COPYING'.IO.f {
			$license = qx/flinkV COPYING/.chomp;
        }
    }
	return $license;
}

sub MAIN (
	Str :$rcp, #= write recipe
	Bool :$split = False, #= generate multi-binary layout
) {
	my %recipe;
	%recipe{q/Source/} = guess_source();
	%recipe{q/Version/} = guess_version();
	%recipe{q/Section/} = guess_section();

	say %recipe;
}

sub MAIN_old ()
{
    # detection
    my $source = guess_source;
    my $version = guess_version;
    my $homepage = guess_homepage;
    my $license = guess_license;
    # let's guess
    say "Source: ", $source;
    say "Section: ", 'utils';
    say "Version: ", $version;
    say "Description: ", $source;
    say 'Homepage: ', $homepage;
	say 'License: ', $license if $license;
    # /usr/share/perl5/Debian/Debhelper/Buildsystem/
    if "CMakeLists.txt".IO.f {
        say "Debhelper-Buildsystem: ", "cmake";
    } elsif "setup.py".IO.f {
        # NOTE Don't ever use the deprecated python_distutils build system
        say "Debhelper-Buildsystem: ", "pybuild";
    } elsif "build.rs".IO.f || "Cargo.toml".IO.f {
        say "Debhelper-Buildsystem: ", "cargo";
    } elsif "go.mod".IO.f || "main.go".IO.f {
        say "Debhelper-Buildsystem: ", "golang";
    } elsif "build.xml".IO.f {
        say "Debhelper-Buildsystem: ", "ant";
    } elsif "meson.build".IO.f {
        say "Debhelper-Buildsystem: ", "meson";
    } elsif "build.ninja".IO.f {
        say "Debhelper-Buildsystem: ", "ninja";
    } elsif "Build.PL".IO.f {
        say "Debhelper-Buildsystem: ", "perl_build";
    } elsif "Makefile.PL".IO.f {
        say "Debhelper-Buildsystem: ", "perl_makemaker";
    } elsif "BUILD".IO.f || "WORKSPACE".IO.f {
        say "Debhelper-Buildsystem: ", "bazel (Not Yet Supported)";
    } elsif "configure".IO.f {
        say "Debhelper-Buildsystem: ", "autoconf";
    } elsif "Makefile".IO.f {
        # XXX The most common one is last checked
        say "Debhelper-Buildsystem: ", "makefile";
    } else {
        # Well, I don't know.
    }
    if '.git/config'.IO.f {
        say 'Uscan: ', $homepage;
    }
    say '';
    say 'Recipe-Binaries:';
    # what can be installed in the main package?
    say ' ' x 4, '.'.IO.absolute.IO.basename, ':';
    if 'bin'.IO.d || 'README.md'.IO.f {
        say ' ' x 8, 'install: |';
        say(' ' x 12, 'bin/* usr/bin/') if 'bin'.IO.d;
		say ' ' x 8, 'docs: |';
		say(' ' x 12, 'README.md') if 'README.md'.IO.f;
    }
	# what can be installed in the doc package?
    if 'doc'.IO.d || 'docs'.IO.d ||
	   'example'.IO.d || 'examples'.IO.d {
        say ' ' x 4, '.'.IO.absolute.IO.basename, '-doc:';
		if 'doc'.IO.d || 'docs'.IO.d {
			say ' ' x 8, 'docs: |';
			say(' ' x 12, 'doc/*') if 'doc'.IO.d;
			say(' ' x 12, 'docs/*') if 'docs'.IO.d;
		}
		if 'example'.IO.d || 'examples'.IO.d {
			say ' ' x 8, 'examples: |';
			say(' ' x 12, 'example/*') if 'example'.IO.d;
			say(' ' x 12, 'examples/*') if 'examples'.IO.d;
		}
    }
	# if the tree looks like something producing shared objects
    if qx/fdfind -d 3 -t d -F include/.chomp.chars > 0 {
        say ' ' x 4, 'lib'~'.'.IO.absolute.IO.basename ~ '0', ':';
        say ' ' x 8, 'install: |';
        say ' ' x 12, 'usr/lib/*.so.*';
        say ' ' x 12, 'usr/lib/*/*.so.*';
        say ' ' x 4, 'lib'~'.'.IO.absolute.IO.basename ~ '-dev', ':';
        say ' ' x 8, 'install: |';
        say ' ' x 12, 'usr/lib/*.so';
        say ' ' x 12, 'usr/lib/*.a';
        say ' ' x 12, 'usr/lib/*/*.so';
        say ' ' x 12, 'usr/lib/*/*.a';
        say ' ' x 12, 'usr/include';
    }
	# provide possible overrides
    say '';
    if 'CMakeLists.txt'.IO.f {
        say 'override_dh_auto_configure: |';
        say ' ' x 4, 'dh_auto_configure -- \\';
        say ' ' x 8, '-DCMAKE_BUILD_TYPE=Release';
    }
}
